<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Planos de Aula com IA</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; margin: 1rem; }
        h1, h2 { color: #4A4A4A; text-align: center; }
        form { display: flex; flex-direction: column; gap: 1rem; }
        input, select, button { padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        button { background-color: #3ECF8E; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #36b880; }
        button#logout-button { background-color: #e53e3e; margin-top: 1rem; }
        button#logout-button:hover { background-color: #c53030; }
        .hidden { display: none; }
        #results { margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .result-item { margin-bottom: 1.5rem; }
        .result-item h3 { color: #3ECF8E; border-bottom: 2px solid #3ECF8E; padding-bottom: 0.5rem; }
        #loading, #error-message { text-align: center; font-weight: bold; margin-top: 1rem; }
        #error-message { color: #e53e3e; }
        pre { background-color: #f4f4f4; padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Gerador de Planos de Aula com IA</h1>

        <div id="auth-section">
            <h2>Acesse sua conta</h2>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit">Login</button>
            </form>
            <p style="text-align: center;">N√£o tem uma conta? Cadastre-se abaixo.</p>
            <form id="signup-form">
                <input type="email" id="signup-email" placeholder="Seu e-mail para cadastro" required>
                <input type="password" id="signup-password" placeholder="Crie uma senha" required>
                <button type="submit">Cadastrar</button>
            </form>
        </div>

        <div id="app-section" class="hidden">
            <p>Ol√°, <span id="user-email"></span>!</p>
            
            <form id="lesson-plan-form">
                <h2>Gerar Novo Plano de Aula</h2>
                <input type="text" id="tema-aula" placeholder="Qual o tema da aula?" required>
                <select id="ano-escolar" required>
                    <option value="" disabled selected>Selecione o ano escolar</option>
                    <option value="1¬∫ ano do Ensino Fundamental">1¬∫ ano do Ensino Fundamental</option>
                    <option value="2¬∫ ano do Ensino Fundamental">2¬∫ ano do Ensino Fundamental</option>
                    <option value="3¬∫ ano do Ensino Fundamental">3¬∫ ano do Ensino Fundamental</option>
                    <option value="4¬∫ ano do Ensino Fundamental">4¬∫ ano do Ensino Fundamental</option>
                    <option value="5¬∫ ano do Ensino Fundamental">5¬∫ ano do Ensino Fundamental</option>
                    <option value="6¬∫ ano do Ensino Fundamental">6¬∫ ano do Ensino Fundamental</option>
                    <option value="7¬∫ ano do Ensino Fundamental">7¬∫ ano do Ensino Fundamental</option>
                    <option value="8¬∫ ano do Ensino Fundamental">8¬∫ ano do Ensino Fundamental</option>
                    <option value="9¬∫ ano do Ensino Fundamental">9¬∫ ano do Ensino Fundamental</option>
                    <option value="1¬∫ ano do Ensino M√©dio">1¬∫ ano do Ensino M√©dio</option>
                    <option value="2¬∫ ano do Ensino M√©dio">2¬∫ ano do Ensino M√©dio</option>
                    <option value="3¬∫ ano do Ensino M√©dio">3¬∫ ano do Ensino M√©dio</option>
                </select>
                <input type="number" id="duracao-minutos" placeholder="Dura√ß√£o da aula em minutos (ex: 50)">
                <button type="submit" id="generate-button">Gerar Plano de Aula</button>
            </form>

            <div id="loading" class="hidden">Gerando seu plano de aula com a IA... Por favor, aguarde.</div>
            <div id="error-message" class="hidden"></div>
            
            <div id="results" class="hidden">
                <h2>Plano de Aula Gerado</h2>
                <div class="result-item"><h3>üí° Introdu√ß√£o L√∫dica</h3><pre id="introducao-result"></pre></div>
                <div class="result-item"><h3>üéØ Objetivo de Aprendizagem (BNCC)</h3><pre id="objetivo-result"></pre></div>
                <div class="result-item"><h3>üë£ Passo a Passo da Atividade</h3><pre id="passo-a-passo-result"></pre></div>
                <div class="result-item"><h3>üìù Rubrica de Avalia√ß√£o</h3><pre id="rubrica-result"></pre></div>
            </div>
            
            <button id="logout-button">Sair</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===================================================================================
        // 1. CONFIGURA√á√ÉO E ELEMENTOS DO DOM
        // ===================================================================================
        const SUPABASE_URL = 'https://tdivbqcveohuaokdlfku.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkaXZicWN2ZW9odWFva2RsZmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDk1ODAsImV4cCI6MjA3NjEyNTU4MH0.R5bUTxo67-c1PdalD5JPsIPIAYJBMLqOjzhwyP-avBI';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const DOM = {
            authSection: document.getElementById('auth-section'),
            appSection: document.getElementById('app-section'),
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            logoutButton: document.getElementById('logout-button'),
            userEmailSpan: document.getElementById('user-email'),
            lessonPlanForm: document.getElementById('lesson-plan-form'),
            generateButton: document.getElementById('generate-button'),
            loadingDiv: document.getElementById('loading'),
            errorDiv: document.getElementById('error-message'),
            resultsDiv: document.getElementById('results'),
            introducaoResult: document.getElementById('introducao-result'),
            objetivoResult: document.getElementById('objetivo-result'),
            passoAPassoResult: document.getElementById('passo-a-passo-result'),
            rubricaResult: document.getElementById('rubrica-result'),
        };

        // ===================================================================================
        // 2. FUN√á√ïES DE UI (INTERFACE DO USU√ÅRIO)
        // ===================================================================================
        const renderUI = (user) => {
            DOM.authSection.classList.toggle('hidden', !!user);
            DOM.appSection.classList.toggle('hidden', !user);
            if (user) {
                DOM.userEmailSpan.textContent = user.email;
            }
        };
        
        const setLoading = (isLoading) => {
            DOM.loadingDiv.classList.toggle('hidden', !isLoading);
            DOM.generateButton.disabled = isLoading;
        };

        const setError = (message = '') => {
            DOM.errorDiv.textContent = message;
            DOM.errorDiv.classList.toggle('hidden', !message);
        };

        const displayResults = (plano) => {
            DOM.introducaoResult.textContent = plano.introducao_ludica;
            DOM.objetivoResult.textContent = plano.objetivo_bncc;
            DOM.passoAPassoResult.textContent = plano.passo_a_passo;
            DOM.rubricaResult.textContent = plano.rubrica_avaliacao;
            DOM.resultsDiv.classList.remove('hidden');
        };

        // ===================================================================================
        // 3. MANIPULADORES DE EVENTOS (EVENT HANDLERS)
        // ===================================================================================
        async function handleSignup(event) {
            event.preventDefault();
            const email = DOM.signupForm.querySelector('input[type="email"]').value;
            const password = DOM.signupForm.querySelector('input[type="password"]').value;
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) alert(`Erro no cadastro: ${error.message}`);
            else alert('Cadastro realizado! Verifique seu e-mail para confirmar a conta.');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = DOM.loginForm.querySelector('input[type="email"]').value;
            const password = DOM.loginForm.querySelector('input[type="password"]').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(`Erro no login: ${error.message}`);
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
        }

        async function handleGeneratePlan(event) {
            event.preventDefault();
            setLoading(true);
            setError('');
            DOM.resultsDiv.classList.add('hidden');

            const body = {
                tema_aula: DOM.lessonPlanForm.querySelector('#tema-aula').value,
                ano_escolar: DOM.lessonPlanForm.querySelector('#ano-escolar').value,
                duracao_minutos: parseInt(DOM.lessonPlanForm.querySelector('#duracao-minutos').value, 10) || null,
            };

            try {
                const { data, error } = await supabaseClient.functions.invoke('gerador-plano-aula', { body });
                if (error) throw error;
                displayResults(data.plano);
            } catch (error) {
                setError(`Ocorreu um erro: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // ===================================================================================
        // 4. INICIALIZA√á√ÉO
        // ===================================================================================
        function initialize() {
            // Verifica a sess√£o inicial
            supabaseClient.auth.getSession().then(({ data: { session } }) => renderUI(session?.user));
            // Escuta por mudan√ßas de autentica√ß√£o
            supabaseClient.auth.onAuthStateChange((_event, session) => renderUI(session?.user));
            // Anexa os eventos aos formul√°rios e bot√µes
            DOM.signupForm.addEventListener('submit', handleSignup);
            DOM.loginForm.addEventListener('submit', handleLogin);
            DOM.logoutButton.addEventListener('click', handleLogout);
            DOM.lessonPlanForm.addEventListener('submit', handleGeneratePlan);
        }

        initialize();
    </script>
</body>
</html>
